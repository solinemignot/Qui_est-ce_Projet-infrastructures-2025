<!DOCTYPE html>
<html lang="en">
<head>
    <title>Harry Potter</title>
    <link rel="stylesheet" type="text/css" href="../static/CSS/stylesheet.css">
    <script src="{{ url_for('static', filename='script.js') }}" ></script>
</head>

<body class="page-jeu-duo">
    <header class="header_jeu_duo">
        <div class="header_text appear">
            <h1>Mode Duel</h1>
            <h4>La magie est dans les d√©tails‚Ä¶ sauras-tu percer le myst√®re ?</h4>
        </div>
    </header>

    <div class="home-wrapper">
        <button class="home-button" onclick="window.location.href='{{ url_for('accueil') }}'">Retour √† l‚Äôaccueil</button>
    </div>

    <h1 class="title-jeu">La salle des portraits est ouverte.</h1>
    <h3>
        Ton objectif : identifier le bon personnage parmi tous ceux pr√©sents ici. Analyse chaque d√©tail, √©limine les suspects et m√®ne ton enqu√™te avec pr√©cision.
        Le myst√®re ne r√©sistera pas longtemps √† un bon d√©tective !
    </h3>

    <div class="jeu-container">
        <div class="zone-grille">
            <div class="grille" id="grille">
                {% for nom, image in personnages.items() %}
                    <div class="carte {% if nom in elimines %}eliminee{% endif %}" 
                        data-nom="{{ nom }}"
                        data-image="{{ image }}"
                        
                        {# On ajoute la description SEULEMENT si on est en mode facile #}
                        {% if session.get('duo_difficulty') == 'easy' %}
                            data-description="{{ descriptions[nom] }}"
                        {% endif %}
                        >
                        
                        <img src="{{ image }}" alt="{{ nom }}">
                        <p>{{ nom }}</p>
                    </div>
                {% endfor %}
            </div>

            <h3>Abandonner la partie</h3>
            <div class="restart-wrapper">
                <button class="restart-button" onclick="window.location.href='/rejouer'">
                    Recommencer
                </button>
            </div>
        </div>

        <div class="zone-questions" id="zone-questions">

            <div class="boite-blanche-duo">
    
                <div class="duo-top-container">
                    
                    {% if session.get('secret_joueur') %}
                    <div class="mon-perso-info">
                        <h4 style="color: #740001; margin: 0 0 10px 0;">Votre Personnage</h4>
                        <div style="width: 80px; margin: 0 auto;">
                            <img src="{{ personnages[session['secret_joueur']] }}" 
                                alt="{{ session['secret_joueur'] }}" 
                                style="width: 100%; border-radius: 5px; border: 2px solid #740001; display: block;">
                            <p style="font-size: 12px; margin-top: 5px; font-weight: bold;">
                                {{ session['secret_joueur'] }}
                            </p>
                        </div>
                        <p style="font-size: 10px; color: grey; margin-top: 5px;">(Secret)</p>
                    </div>
                    {% endif %}

                    <div class="adversaire-info">
                        <h3 style="margin-top: 0;">Grille de votre adversaire</h3>
                        <p style="font-size: 14px; margin-bottom: 10px;">Ce que l'ordinateur pense :</p>
                        
                        <div class="grille-mini">
                            {% for nom, image in personnages.items() %}
                                <div class="carte-mini {% if nom not in restants_opponent %}eliminee{% endif %}">
                                    <img src="{{ image }}" alt="{{ nom }}">
                                </div>
                            {% endfor %}
                        </div>
                    </div>

                </div>
            </div>

            <div class="zone-question-perso" id="zone-question-perso">
                <p>Pose des questions pour tenter de d√©couvrir le personnage cach√©.</p>
                <p>Apr√®s chaque r√©ponse, clique sur les personnages concern√©s pour les griser et ainsi les √©liminer de la liste des suspects.</p>
                <p>Une fois que tu as gris√© les personnages concern√©s, clique sur "Tour de l‚Äôordinateur" pour que l‚Äôordinateur pose une question.</p>

                <h2>Pose une question :</h2>
                <form method="POST" action="/jeu_duo#zone-questions">
                    <select name="question" required style="width:200px;"
                            {% if awaiting_computer %}disabled{% endif %}>
                        <option value="">Choisir une question</option>
                        {% for q in questions %}
                            {% set i = loop.index0 %}
                            <option value="{{ i }}" {% if i in asked_questions %}disabled{% endif %}>
                                {{ q.question }}
                            </option>
                        {% endfor %}
                    </select>
                    <br><br>
                    <button type="submit" {% if awaiting_computer %}disabled{% endif %}>Poser la question</button>
                </form>
                {% if session.get('duo_difficulty') == 'easy' %}
                    <p style="font-size: 14px; color: #888; margin-top: 15px; font-style: italic;">
                        üí° Petit indice : clique droit sur chaque sorcier pour en apprendre un peu plus !
                    </p>
                {% else %}
                    <p style="font-size: 14px; color: #888; margin-top: 15px; font-style: italic;">
                        üîç Mode difficile : Aucune description disponible, fais confiance √† ta m√©moire ! 
                    </p>
                {% endif %}

                {% if reponse %}
                    <div class="simple-answer {{ 'yes' if reponse == 'Oui' else 'no' }}">
                        {{ reponse }}
                    </div>
                {% endif %}

                <!--bouton pour lancer le tour de l'ordi apres avoir gris√© -->
                {% if awaiting_computer %}
                    <form method="POST" action="/jeu_duo#zone-question-perso" style="margin-top: 15px;">
                        <button type="submit" name="next_turn" value="1" class="restart-button">
                            Tour de l‚Äôordinateur
                        </button>
                    </form>
                {% endif %}

            </div>

            <div class="zone-guess">
                <p>Tu as trouv√© ? Sois s√ªr de toi ! Tu n‚Äôas droit qu‚Äô√† une seule tentative : une mauvaise r√©ponse et la partie est perdue.</p>
                <h2>R√©v√®le le coupable</h2>

                <form method="POST" action="/jeu_duo">
                    <select name="guess" required style="width:200px;"
                            {% if awaiting_computer %}disabled{% endif %}>
                        <option value="">Choisir un personnage</option>
                        {% for nom in personnages.keys() %}
                            {% if nom not in elimines %}
                                <option value="{{ nom }}">{{ nom }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <br><br>
                    <button type="submit" {% if awaiting_computer %}disabled{% endif %}>Deviner</button>
                </form>

                {% if opponent_question_idx is not none %}
                <div class="modal">
                    <div class="modal-content">
                        <h3>L‚Äôordinateur demande :</h3>
                        <p>{{ questions[opponent_question_idx].question }}</p>
                        <form method="POST" action="/jeu_duo#grille">
                            <button name="answer_opponent" value="Oui" class="opponent-button">Oui</button>
                            <button name="answer_opponent" value="Non" class="opponent-button no">Non</button>
                        </form>
                    </div>
                </div>
                {% endif %}

            </div>

        </div>
    </div>

    <div id="info-modal" class="modal-info">
        <div class="modal-info-content">
            <span class="close-modal">&times;</span>
            <img id="modal-img" src="" alt="">
            <h2 id="modal-title">Nom</h2>
            <p id="modal-desc">Description...</p>
        </div>
    </div>

    <script>
        window.addEventListener('DOMContentLoaded', function() {
            // INITIALISER LA MODAL
            const { modal, modalImg, modalTitle, modalDesc } = initModal();

            // --- 2. Boucle sur toutes les cartes ---
            document.querySelectorAll('.carte').forEach(card => {
            
                // A. GESTION DU CLIC GAUCHE (Ton code original pour √©liminer)
                card.addEventListener('click', async () => {
                    const nom = card.dataset.nom;
                    // On appelle le serveur pour changer l'√©tat
                    await fetch(`/toggle_elimine_duo/${encodeURIComponent(nom)}`, { method: 'POST' });
                    // On grise/d√©grise visuellement
                    card.classList.toggle('eliminee');
                });

                // B. GESTION DU CLIC DROIT (Nouveau : pour voir la description)
                card.addEventListener('contextmenu', function(e) {
                    // On regarde si une description existe (donc si on est en mode Facile)
                    if (this.dataset.description) {
                        e.preventDefault(); // Bloque le menu clic-droit normal

                        // Remplir la fen√™tre avec les infos de la carte
                        modalTitle.textContent = this.dataset.nom;
                        modalDesc.textContent = this.dataset.description;
                        modalImg.src = this.dataset.image;

                        // Afficher la fen√™tre
                        modal.style.display = "block";
                    }
                    // Si pas de description (Mode Difficile), le menu normal s'affiche
                });
            });
        });

    </script>

</body>
</html>
